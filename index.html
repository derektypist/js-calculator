<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>JavaScript Calculator</title>
    <!-- Load Style Sheets -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <style>
        /* Body */

        body {
            font-family: "Roboto", Arial, Verdana, sans-serif;
            margin-top: 3em;
        }

        /* Calculator */

        #calculator {
            width: 50%;
            margin: auto;

        }

        /* Title */

        #title {
            background: black;
            font-size: 1.3em;
            color: white;
            text-align: center;
        }

        #title p {
            margin: auto;
            padding: 20px;


        }

        /* Display and History */

        #display {
            height: 100px;
            background: seagreen;
            color: white;
        }

        #history {
            height: 40px;
            background: seagreen;
            color: white;
            border: none;
        }

        .row,
        #display,
        #history {
            text-align: right;
        }

        /* Buttons */

        #clear {
            color: turquoise;
        }

        #settings {
            color: orange;
        }

        button {
            font-size: 2em;
            background: black;
            color: white;
            border-color: lightgreen;
            margin-left: 0px;
            margin-right: 0px;
            height: 2em;
            float: left;
        }

        button:hover {
            background: navy;
            color: white;
        }

        #equal:hover {
            background: turquoise;
        }

        #clear:hover {
            background: green;
        }

        #settings:hover {
            background: purple;
        }

        .row button {
            width: 25%;
        }
    </style>

    <!-- Load Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/mathjs@6.6.1/dist/math.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            // Define Global Variables

            var $display = $("#display");
            var $history = $("#history");
            var $display_history = $("#display, #history");
            var operationType = "";
            var answer = 0;
            var hasDecimalPoint = false;
            var $endsWithOperator = new RegExp(/(\-)$|(\+)$|(\%)$|(\/)$|(\x)$/);
            var iterations = 0;
            const DISPLAY_BACKGROUND_COLORS = ["seagreen", "blue", "purple", "orangered", "olive", "brown", "deeppink"];
            const bigmath = math.create({
                number: 'BigNumber',
                precision: 16
            });



            initializeCalc();

            /* FONT SCALING */
            //Scales font size on main display in case of long numbers

            function fontSizing() {
                var fontSize;
                if ($display.text().length > 18) {
                    fontSize = $display.width() * 0.05; // 5% of display div width
                }
                else if ($display.text().length > 13) {
                    fontSize = $display.width() * 0.07; // 7% of display div width
                }
                else {
                    fontSize = $display.width() * 0.10; // 10% of display div width
                }
                $display.css('font-size', fontSize);
            }

            // Set Up Number Buttons

            $(".digit:not(#zero)").click(function() {
                
                if (operationType == "evaluated") {
                    $display_history.html($(this).text());
                    fontSizing();
                    hasDecimalPoint = false;
                    operationType = "number";
                }
                else if (lockNumbersAndDecimals()) { // Apply Lock
                } 
                
                else if (operationType == "negative" || operationType == "point"){
                    $display_history.append($(this).text());
                    fontSizing();
                    operationType == "point" ? operationType = "number" : operationType = "negative";
                } else {
                    /(\s0)|x|\+|—|\//.test($display.text()) ? $display.html('') : $display.html();
                    $display_history.append($(this).text());
                    fontSizing();
                    operationType = "number";
                }

            });


            $("#zero").click(function() {
                if (operationType == "evaluated") {
                    initializeCalc();
                }
                else if (/(\s0)$|-$|x|\+|—|\//.test($display.text()) || lockNumbersAndDecimals()) { // Prevents Unwanted Zeros 
                }
                else {
                    $display_history.append("0");
                    fontSizing();
                    operationType = "number";
                }

            });

            $("#decimal").click(function() {
                var historyStr = $history.text();
                if (operationType == "evaluated" || hasDecimalPoint || lockNumbersAndDecimals()) { // Apply Lock
                }
                else {
                    if (operationType == "negative" && $display.text() == "-" || operationType == "operator" && $display.text() == "-") {
                        $display_history.append("0.");
                        fontSizing();
                    }
                    else if (operationType == "negative" && /(\d+)$/.test(historyStr)) {
                        $display_history.append(".");
                        fontSizing();
                    }
                    else if (operationType == "operator" || operationType == "negative" || $display.html() == ' 0') {
                        $history.append("0.");
                        $display.html("0.");
                        fontSizing();

                    }
                    else {
                        $display_history.append(".");
                    }
                    hasDecimalPoint = true;
                    operationType = "point";

                }
            });


            // Lock Function
            function lockNumbersAndDecimals() {
                if (operationType != "evaluated") {
                    return $display.text().length > 20 ||
                        $history.text().length > 64 ||
                        $display.text().indexOf("Met") != -1 ||
                        $history.text() !== '' &&
                        $history.text().lastIndexOf('.') == $history.text().length - 1;
                }
            }


            // Set Up Operations Buttons

            $("#posNeg").click(function() {
                var bigNum = bigmath.bignumber($display.children().html());
                text = bigNum.toNumber() * -1;
                if (text < 0) {
                    operationType = "negative";
                }
                else {
                    operationType = "positive";
                }
                displayText();
                displayHistory();
                clear();
            });

            $("#add").click(function() {
                equal(); //call equal to perform current operation before switching to new operation
                operation = "plus";
                operationType = "operator";
                add();
                numText += " " + $("#add").html() + " ";
                clear();
            });

            $("#subtract").click(function() {
                equal();
                operation = "minus";
                operationType = "operator";
                subtract();
                numText += " " + $("#subtract").html() + " ";
                clear();
            });

            $("#divide").click(function() {
                equal();
                operation = "divide";
                operationType = "operator";
                divide();
                numText += " " + $("#divide").html() + " ";
                clear();
            });

            $("#multiply").click(function() {
                equal();
                operation = "multiply";
                operationType = "operator";
                multiply();
                numText += " " + $("#multiply").html() + " ";
                clear();
            });

            $("#percent").click(function() {
                operation = "percent";
                operationType = "operator";
                percent();
                equal();
                numText += " " + $("#percent").html() + " ";
                clear();
            });

            // Set Up Operations Functions

            function add() {
                if ($display.children().html() !== undefined) {
                    var bigNum = bigmath.bignumber($display.children().html());
                    numArray.push(bigNum.toNumber());
                }
                else {
                    numArray.push(0);
                }
                console.log(numArray);
                //if numArray only has one number, don't perform any operations
                if (numArray.length === 1) {
                    text = numArray[0];
                    console.log(numArray);
                    displayText();
                }
                else {
                    numArray = [numArray.reduce(function(prev, curr) {
                        prev = bigmath.bignumber(prev).toNumber();
                        curr = bigmath.bignumber(curr).toNumber();
                        return bigmath.add(prev, curr);
                    })];
                    text = numArray[0];
                    console.log(numArray);
                    displayText();
                }
            }

            function subtract() {
                if ($display.children().html() !== undefined) {
                    var bigNum = bigmath.bignumber($display.children().html());
                    numArray.push(bigNum.toNumber());
                }
                else {
                    numArray.push(0);
                }
                console.log(numArray);
                if (numArray.length === 1) {
                    text = numArray[0];
                    console.log(numArray);
                    displayText();
                }
                else {
                    numArray = [numArray.reduce(function(prev, curr) {
                        prev = bigmath.bignumber(prev).toNumber();
                        curr = bigmath.bignumber(curr).toNumber();
                        return bigmath.subtract(prev, curr);
                    })];
                    text = numArray[0];
                    console.log(numArray);
                    displayText();
                }
            }

            function multiply() {
                if ($display.children().html() !== undefined) {
                    var bigNum = bigmath.bignumber($display.children().html());
                    numArray.push(bigNum.toNumber());
                }
                else {
                    numArray.push(0);
                }
                console.log(numArray);
                if (numArray.length === 1) {
                    text = numArray[0];
                    console.log(numArray);
                    displayText();
                }
                else {
                    numArray = [numArray.reduce(function(prev, curr) {
                        prev = bigmath.bignumber(prev).toNumber();
                        curr = bigmath.bignumber(curr).toNumber();
                        return bigmath.multiply(prev, curr);

                    })];
                    text = numArray[0];
                    console.log(numArray);
                    displayText();
                }
            }

            function divide() {
                if ($display.children().html() !== undefined) {
                    var bigNum = bigmath.bignumber($display.children().html());
                    numArray.push(bigNum.toNumber());
                }
                else {
                    numArray.push(0);
                }
                console.log(numArray);
                if (numArray.length === 1) {
                    text = numArray[0];
                    console.log(numArray);
                    displayText();
                }
                else {
                    numArray = [numArray.reduce(function(prev, curr) {
                        prev = bigmath.bignumber(prev).toNumber();
                        curr = bigmath.bignumber(curr).toNumber();
                        return bigmath.divide(prev, curr);
                    })];
                    text = numArray[0];
                    console.log(numArray);
                    displayText();
                }
            }

            function percent() {
                if ($display.children().html() !== undefined) {
                    var bigNum = bigmath.bignumber($display.children().html());
                    numArray.push(bigNum.toNumber());
                }
                else {
                    numArray.push(0);
                }
                console.log(numArray);
                numArray = [numArray.reduce(function(prev, curr) {
                    prev = bigmath.bignumber(prev).toNumber();
                    curr = bigmath.bignumber(100).toNumber();
                    return bigmath.divide(prev, curr);
                })];
                text = numArray[0];
                console.log(numArray);
                displayText();
            }

            //Equal calls the last operation performed
            function equal() {
                console.log(operation);
                if (operation === "plus") {
                    add();
                }
                else if (operation === "minus") {
                    subtract();
                }
                else if (operation === "multiply") {
                    multiply();
                }
                else if (operation === "divide") {
                    divide();
                }
                else if (operation === "percent") {
                    percent();
                }
                operation = "";
                operationType = "evaluated";
                numArray = [];
            }



            // Initialize Calculator
            function initializeCalc() {
                $display.html(' 0');
                $history.html('');
                numArray = [];
                text = "";
                numText = "";
                operation = "";
                operationType = undefined;
            }




            // Set Up Equal, Clear and Settings Buttons
            $("#equal").click(function() {

                equal();
                $history.empty();
                numText = text;

            });



            // Clear Button will reset everything
            $("#clear").click(initializeCalc);

            function clear() {
                text = "";
            }



            // Settings Functions

            $("#settings").click(changeDisplayBackgroundColor);

            function changeDisplayBackgroundColor() {
                iterations++;
                $("#history").css("background-color", DISPLAY_BACKGROUND_COLORS[iterations % 7]);
                $("#display").css("background-color", DISPLAY_BACKGROUND_COLORS[iterations % 7]);
            }

            // Display Functions
            function displayText() {
                var displayTags = `<p>${text}</p>`;
                fontSizing();
                $display.html(displayTags);
            }

            function displayHistory() {
                var historyText = `<p>${numText}</p>`;
                $history.html(historyText);
            }

            // Find Last Index of Operator
            function lastIndexOfOperator(str) {
                return [str.lastIndexOf('‑'), str.lastIndexOf('+'),
                    str.lastIndexOf('/'), str.lastIndexOf('*')
                ].sort(function(a, b) {

                    return a < b;

                })[0];


            }


        }); // End Document Ready
    </script>
</head>

<body>
    <!-- Set Up Calculator -->
    <section class="container-fluid" id="calculator">
        <!-- Set Up Title, History and Display -->
        <article id="title">
            <p>JavaScript Calculator</p>
        </article>
        <article id="history"></article>
        <article id="display"></article>
        <!-- Set Up First Row -->
        <article class="row">
            <button id="clear">C</button>
            <button id="posNeg">&plusmn;</button>
            <button id="percent">%</button>
            <button id="divide">&divide;</button>
        </article>

        <!-- Set Up Second Row -->
        <article class="row">
            <button class="digit" id="one">1</button>
            <button class="digit" id="two">2</button>
            <button class="digit" id="three">3</button>
            <button id="add">+</button>
        </article>

        <!-- Set Up Third Row -->
        <article class="row">
            <button class="digit" id="four">4</button>
            <button class="digit" id="five">5</button>
            <button class="digit" id="six">6</button>
            <button id="subtract">-</button>
        </article>

        <!-- Set Up Fourth Row -->
        <article class="row">
            <button class="digit" id="seven">7</button>
            <button class="digit" id="eight">8</button>
            <button class="digit" id="nine">9</button>
            <button id="multiply">&times;</button>
        </article>

        <!-- Set Up Fifth Row -->
        <article class="row">
            <button class="digit" id="zero">0</button>
            <button id="decimal">.</button>
            <button id="equal">=</button>
            <button id="settings" title="Change display background color">S</button>
        </article>
    </section>
</body>

</html>
